{% extends "base.html" %}

{% block title %}Edit Blog - {{ title|truncate(10) }}{% endblock %}

{% block head %}
    <link rel="canonical" href="https://kjhjason.com/admin/blogs/{{ id }}/edit" />
    <meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block content %}
    <button hx-on:click="goBackToBlog()" class="btn btn-primary mb-4">
        <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4"/>
        </svg>
        Back to Blog
    </button>
    {% include "components/blog_input_div.html" %}
    <template id="title-template">{{ title }}</template>
    <template id="tags-template">{{ tags }}</template>
    <template id="content-template">{{ content }}</template>
{% endblock %}

{% block scripts %}
    <script nonce="{{ common.nonce }}" src="/static/js/blog.js"></script>
    <script nonce="{{ common.nonce }}">
        const goBackToBlog = () => {
            Swal.fire({
                title: "Are you sure?",
                text: "You will lose all unsaved changes!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes",
                cancelButtonText: "No",
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/blogs/{{ id }}";
                }
            });
        };

        csrfHeaderName = "{{ common.csrf_header }}";
        csrfValue = "{{ common.csrf_value }}";
        useLocalStorage = false;
        isPublic.checked = "{{ public }}" === "true";
        content.value = document.getElementById("content-template").innerHTML;
        contentPreview.value = content.value;
        tags.value = document.getElementById("tags-template").innerHTML;
        title.value = document.getElementById("title-template").innerHTML;
        titlePreivew.innerText = title.value;

        let newFiles = [];
        fileUploadResponseHandler = (file) => {
            newFiles.push(file);
        };

        const postBlog = () => {
            const tileVal = title.value;
            const contentVal = content.value;
            const tagsVal = parseTags(tagsInp.value);

            if (tileVal.length === 0 || contentVal.length === 0) {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Title and content are required!",
                });
                return;
            }
            if (tagsVal.length > maxTags) {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Max 8 tags allowed!",
                });
                return;
            }

            fetch("/api/blog/update", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "{{ common.csrf_header }}": "{{ common.csrf_value }}",
                },
                body: JSON.stringify({
                    id: "{{ id }}",
                    title: tileVal,
                    tags: tagsVal,
                    new_files: newFiles,
                    content: contentVal,
                    is_public: isPublic.checked,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to update blog!", response);
                    }
                    swal.fire({
                        icon: "success",
                        title: "Success!",
                        text: "Blog updated!",
                        confirmButtonText: "Continue Editing",
                        cancelButtonText: "View Blog",
                        showCancelButton: true,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            newFiles = [];
                            return;
                        }
                        window.location.href = "/blogs/{{ id }}";
                    });
                })
                .catch((error) => {
                    console.error("Error:", error);
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Failed to update blog!",
                    });
                });
        };
    </script>
{% endblock %}
